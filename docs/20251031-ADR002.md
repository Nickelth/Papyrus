# ADR 002: ALB と ECS タスクの AZ カバレッジ方針（TargetHealth=unused 対策）

- Status: Accepted
- Date: 2025-10-31
- Owners: Papyrus Invoice
- Related: ADR-001, infra/20-alb, .github/workflows/alb-smoke.yml

## Context
スモーク実行時、TargetGroup にタスク IP を登録しても `TargetHealth=unused` が継続。  
原因調査の結果、**ALB が有効化されている AZ (subnets)** と **ECS タスクが起動した AZ** が不一致であり、ALB が該当ターゲットに対してヘルスチェックを実施できていなかった。

- 事象: ALB = us-west-2a/2b, タスク = us-west-2c → `unused`
- Listener → TG 紐付けおよび HC 設定 (/healthz, 200–399) は正しい状態

## Decision
- **スモーク用 ALB のサブネットに、ECS サービスの配置 AZ を必ず含める。**
  - 本件では `PUBLIC_SUBNET_IDS_JSON` に **us-west-2c の public subnet** を追加し、ALB を 2a/2b/2c で有効化する。
- CI に **AZ ミスマッチ検知ステップ** を常設し、ズレがある場合は即 Fail させる。
  - `describe-load-balancers` の `AvailabilityZones[].ZoneName` と、タスク ENI の `AvailabilityZone` を比較。

## Alternatives
1. **ECS サービスの配置 AZ を ALB 側に合わせて固定**  
   - 長所: ALB のサブネット数最小化。  
   - 短所: タスクの配置柔軟性が低下。スモーク用途としては運用負担が増える。
2. **CI で ALB のサブネットを動的に増減**  
   - 長所: 自動回復的。  
   - 短所: Terraform 管理外の変更が出るため、IaC 方針に反する。

## Consequences
- スモーク ALB の有効 AZ が増えるため、作成時の ENI/費用がごく僅かに増加。
- 以後、AZ 不一致による `unused` は CI の早期検知で即時に中断され、原因がログに残る。

## Verification
- `aws elbv2 describe-target-health` が `healthy` に遷移すること
- `/healthz` が `HTTP/1.1 200 OK` を返し、`evidence/*_healthz.log` が生成されること

## Evidence
- CI ログ:  
  `[INFO] ALB zones: us-west-2a us-west-2b us-west-2c`  
  `[INFO] TASK az  : us-west-2c`  
- `evidence/*_tg_health.json`（必要に応じて）
