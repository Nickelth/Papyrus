## RDS起動(TF)->Secret更新->VPC疎通確認(ECS Exec)

### 0. 現行Secretの中身確認
```bash
aws secretsmanager get-secret-value \
  --secret-id papyrus/prd/db \
  --region us-west-2 \
  --query SecretString --output text | jq .
```

### 1. RDS再起動

#### 1.1 init/validate/plan

/home/cloudshellは1GBという低容量のため、作業ディレクトリを/tmpに変更する。

```bash
export TF_PLUGIN_CACHE_DIR=/tmp/tf-plugin-cache
mkdir -p "$TF_PLUGIN_CACHE_DIR" /tmp/papyrus-10-rds/.terraform
rsync -av --exclude='.terraform' ~/papyrus-invoice/infra/10-rds/ /tmp/papyrus-10-rds/
cd /tmp/papyrus-10-rds
terraform init
terraform fmt -recursive
terraform validate
terraform plan -var-file=dev.tfvars | tee ~/papyrus-invoice/docs/evidence/$(date +%Y%m%d_%H%M%S)_papyrus_tf_plan.log
```

#### 1.2 apply

```bash
terraform apply -auto-approve -var-file=dev.tfvars | tee ~/papyrus-invoice/docs/evidence/$(date +%Y%m%d_%H%M%S)_papyrus_tf_apply.log
```

#### 1.3 endpoint

```bash
EP=$(terraform output -raw rds_endpoint)
PORT=$(terraform output -raw rds_port)
echo "$EP:$PORT" | tee ~/papyrus-invoice/docs/evidence/$(date +%Y%m%d_%H%M%S)_papyrus_rds_endpoint.log
```

### 2. Secret更新

#### 2.1 正しいエンドポイント取得

```bash
EP=$(aws rds describe-db-instances \
  --db-instance-identifier papyrus-pg16-dev \
  --region us-west-2 \
  --query 'DBInstances[0].Endpoint.Address' --output text)
```

#### 2.2 既存Secretを読み出し

```bash
CUR=$(aws secretsmanager get-secret-value \
  --secret-id papyrus/prd/db \
  --region us-west-2 \
  --query SecretString --output text)
```

#### 2.3 hostだけ置換して一時ファイルへ

```bash
echo "$CUR" | jq --arg ep "$EP" '.host=$ep' > /tmp/papyrus_prd_db.json
```

#### 2.4 上書き（履歴残る）

```bash
aws secretsmanager put-secret-value \
  --secret-id papyrus/prd/db \
  --secret-string file:///tmp/papyrus_prd_db.json \
  --region us-west-2 | tee docs/evidence/$(date +%Y%m%d_%H%M%S)_sm_put_db_secret.json
```

### 3. タスク再起動

```bash
aws ecs update-service \
  --cluster papyrus-ecs-prd \
  --service papyrus-task-service \
  --force-new-deployment \
  --region us-west-2
```

#### 3.1 ecs-deploy.yml 実行 (GHActions Manually)

#### 3.2 psql connection test

```bash
PGPASSWORD="$(awk -F'=' '/db_password/ {print $2}' dev.tfvars | tr -d ' \"')" \
psql "host=$EP port=$PORT dbname=papyrus user=$(awk -F'=' '/db_username/ {print $2}' dev.tfvars | tr -d ' \"')" \
  -c "SELECT version();" \
  | tee ~/papyrus-invoice/docs/evidence/$(date +%Y%m%d_%H%M%S)_papyrus_psql_connect.log
```

### 4. VPCから疎通確認

```bash
TASK_ARN=$(aws ecs list-tasks \
  --cluster papyrus-ecs-prd \
  --service-name papyrus-task-service \
  --region us-west-2 \
  --query 'taskArns[0]' --output text)

aws ecs execute-command \
  --cluster papyrus-ecs-prd \
  --task "$TASK_ARN" \
  --container app \
  --region us-west-2 \
  --interactive \
  --command "python - <<'PY'
import os, json, psycopg2, boto3
sm = boto3.client('secretsmanager', region_name='us-west-2')
sec = sm.get_secret_value(SecretId='papyrus/prd/db')
db = json.loads(sec['SecretString'])
print('HOST:', db['host'])
conn = psycopg2.connect(host=db['host'], port=db.get('port',5432),
                        dbname=db.get('database','papyrus'),
                        user=db['username'], password=db['password'],
                        connect_timeout=5)
cur = conn.cursor(); cur.execute('SELECT 1'); print('DB OK:', cur.fetchone())
conn.close()
PY"
```