# ADR-2025-10-31: VPCサブネット拡張（AZ C 追加）によるALB疎通回復

**Status**: Accepted
**Date**: 2025-10-31 JST
**Owner**: Papyrus Invoice（ECS/Fargate + ALB）
**Tags**: VPC, Subnet, ALB, Health check

## 背景 / Context

- 既存構成で ALB 経由のスモークテストが不安定。ターゲットのヘルスが安定せず、疎通性に揺らぎ。
- ALB は複数AZのサブネットを要求する。各有効AZにつき1サブネット、スケールのため /27 以上と十分な空きIPが推奨。([AWS ドキュメント][1])
- ネットワークマッピング上、AZ C が未採用だったため、ALB と ECS サービスの配置候補が乏しく、IP在庫圧迫やAZ障害時の冗長性が不足。

## 変更 / Decision

- **VPC の有効サブネットを AZ C まで拡張**し、ALB の Network mapping に **AZ C のサブネットを追加**。ECS サービスも AZ C への配置を許可。([AWS ドキュメント][2])

## 結果 / Consequences

- スモークテスト成功（ALB 経由 GET `/healthz` 200/OK）。ターゲットグループのヘルスも安定（成功コードはデフォルト200、必要に応じて200-299に拡張可）。([AWS ドキュメント][3])
- `/dbcheck` はアプリ側500で失敗。L4/L7疎通は生きているが、アプリ or DB で例外発生の状態。
- 可用性とスケール余地は改善（複数AZ要件充足）。([AWS ドキュメント][1])

## 選択肢 / Alternatives

1. 既存AZのみでIP在庫整理やスケール制御を調整
2. NLB へ変更（要件次第）
3. CloudFrontやAPI Gatewayなど別終端へ変更
   → いずれも工期や非互換が大きく、最短で可用性を上げる目的に反するため不採用。

## 影響範囲 / Trade-offs

- サブネット増加に伴う CIDR 管理とアドレス在庫の監視が必要。/27 以上と未使用IPを維持する運用を標準化。([AWS ドキュメント][4])
- AZ 追加によりコストは微増する可能性。だがSLAとスケール余地のほうが優先。

## リスク / Risks

- ルートテーブル、NACL、SG の設定差異による AZ 間挙動不一致
- ECS タスクの SG と RDS SG の組合せ不備による DB 到達不能（今回の500の根因候補）([AWS ドキュメント][5])

## 証跡 / Evidence

### Papyrus Smoke #42

- `/healthz`:

  ```
  HTTP/1.1 200 OK
  Server: gunicorn
  {"ok":true}
  ```
- `/dbcheck`:

  ```
  HTTP/1.1 500 INTERNAL SERVER ERROR
  Server: gunicorn
  ```
- ALB Network mapping に AZ C を追加後、スモークテスト成功（時刻: 2025-10-31T07:35:14Z）

## モニタリング / Metrics

- TargetGroup ヘルス割合、ALB 4xx/5xx、タスク起動/停止イベント
- RDS 接続失敗ログ（アプリ/DB側）と到達可能性検査

## ロールバック / Rollback

- AZ C を Disable し、ALB からサブネットを除外（ただし可用性/スケール後退）。([AWS ドキュメント][2])

## 参照 / References

- ALB の AZ/subnet 要件とCIDR推奨: AWS Docs（ALB 概要・作成手順）([AWS ドキュメント][1])
- ターゲットヘルスチェック仕様（成功コード/失敗回数）: AWS Docs ([AWS ドキュメント][3])
- ALB トラブルシュート（成功コード等）: AWS Docs, Re:Post ([AWS ドキュメント][6])
- RDS セキュリティグループ基礎（SG参照ルール）: AWS Docs ([AWS ドキュメント][5])
- Reachability Analyzer（到達可能性の静的解析）: AWS Docs（英/日）([AWS ドキュメント][7])

---

[1]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-application-load-balancer.html?utm_source=chatgpt.com "Create an Application Load Balancer - AWS Documentation"
[2]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-subnets.html?utm_source=chatgpt.com "Update the Availability Zones for your Application Load Balancer"
[3]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/target-group-health-checks.html?utm_source=chatgpt.com "Health checks for Application Load Balancer target groups"
[4]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/application-load-balancers.html?utm_source=chatgpt.com "Application Load Balancers"
[5]: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Overview.RDSSecurityGroups.html?utm_source=chatgpt.com "Controlling access with security groups"
[6]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-troubleshooting.html?utm_source=chatgpt.com "Troubleshoot your Application Load Balancers"
[7]: https://docs.aws.amazon.com/vpc/latest/reachability/what-is-reachability-analyzer.html?utm_source=chatgpt.com "What is Reachability Analyzer?"
[8]: https://docs.aws.amazon.com/vpc/latest/reachability/getting-started.html?utm_source=chatgpt.com "Getting started with Reachability Analyzer - AWS Documentation"
[9]: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/security-network.html?utm_source=chatgpt.com "Network security best practices for Amazon ECS"
