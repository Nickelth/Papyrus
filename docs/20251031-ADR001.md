# ADR 001: スモーク用 ALB/TG 設計と健全性確認フロー

- Status: Accepted
- Date: 2025-10-31
- Owners: Papyrus Invoice
- Related: ADR-002 (AZカバレッジ方針), infra/20-alb, .github/workflows/alb-smoke.yml

## Context
ポートフォリオ用途の短時間スモークで、ECS Fargate 上のアプリを ALB 経由で `/healthz` `/dbcheck` 叩き、証跡を生成する必要がある。本番恒久ALBは今回スコープ外。

## Decision
1. **一時 ALB/TG を Terraform で作成し、必ず破棄**する（課金抑制とステート健全性のため）。
2. **Target Group は IP ターゲット**、**ヘルスチェックは `/healthz`、HTTP 200–399** を正とする。
3. **Listener → TG の紐付けを CI で冪等に保証**する（既存流用、重複検知、張替えを許容）。
4. **ALB→ECS セキュリティグループの 5000/tcp を CI で一時許可**し、終了時に撤去する。
5. **ターゲットの Healthy 待機は公式 waiter を使わず自前ループ**（`describe-target-health` で確認）を採用。
6. **Evidence** は `evidence/*_healthz.log`, `*_dbcheck.log`, `infra/20-alb/terraform.tfstate` をアーティファクト化・保存。

## Rationale
- スモークの主目的は「配線と到達性の証跡」。恒久 ALB 構築はオーバーエンジニアリング。
- `/healthz` を HC に固定することで 404 起因の false negative を回避。
- CI 側での冪等なリスナー設定により、Terraform/実環境の差異に影響されない。

## Consequences
- 一時的に ALB/TG/Listener/SG ルールを作成するため、CI 実行中のみ最小限コストが発生。
- スモークの可用性は ECS タスクの起動可否と AZ カバレッジに依存（AZについては ADR-002 を参照）。

## Evidence
- `evidence/YYYYMMDD_HHMMSS_healthz.log`（HTTP/1.1 200 OK, {"ok":true}）
- `evidence/YYYYMMDD_HHMMSS_dbcheck.log`（HTTP/1.1 200 OK, {"inserted":true,"ok":true} 予定）
- `infra/20-alb/terraform.tfstate`（一時リソースの構成証跡）

## Rollback
- CI の最後に `terraform destroy` を常時実行。失敗時はワークフローを Fail にすることで残骸放置を阻止。
